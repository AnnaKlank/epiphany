---
- name: Check if the secrets file exists
  delegate_to: localhost
  become: false
  stat:
    path: "{{ vault_location }}/kubernetes-secrets.yml"
    get_attributes: false
    get_checksum: false
    get_mime: false
  register: stat_kubernetes_secrets_yml

- name: Set kubeconfig to server
  when: stat_kubernetes_secrets_yml.stat.exists
  block:
    - name: Include vars of Kubernetes secrets
      delegate_to: localhost
      become: false
      include_vars:
        file: "{{ vault_location }}/kubernetes-secrets.yml"
 
    - name: Create kubeconfig file for local usages
      delegate_to: localhost
      become: false
      template:
        src: kubeconfig.j2
        dest: "{{ vault_location }}/../admin.conf"
        mode: u=rw,go=r

    - name: Replace IP address with localhost for tunnel usage
      delegate_to: localhost
      become: false
      replace:
        path: "{{ vault_location }}/../admin.conf"
        after: '://'
        before: ':6443'
        regexp: '^(.+)$'
        replace: "localhost"

    # Please notice this task file can be executed from other playbooks,
    # hence the fallback "default(groups.kubernetes_master.0)" must be defined.
    - delegate_to: "{{ kubernetes_common.automation_designated_master | default(groups.kubernetes_master.0) }}"
      block:
        - name: Create .kube directory if it does not exist
          file:
            path: "/home/{{ admin_user.name }}/.kube/"
            state: directory

        - name: Create kubeconfig file
          template:
            src: kubeconfig.j2
            dest: "/home/{{ admin_user.name }}/.kube/config"
            mode: u=rw,go=r
